<!doctype html>

<html lang="en">
  <head>
    <meta charset="utf-8">

    <title>Stock Verification</title>
    <%= javascript_include_tag 'jquery' %>

    <script>
      var target;
      var delivery_date = <%= @delivery_date.to_json %>;
      var drugs = <%= @drugs.to_json %>;
      var formatted_drugs = <%= @formatted.to_json %>;
      var drug_short_names = <%= @drug_short_names.to_json %>;
      var selected = <%= params[:drug_name].to_json %>;
      var drug_cms_names = <%= @drug_cms_names.to_json %>;
      var drug_cms_packsizes = <%= @drug_cms_packsizes.to_json %>;
      var drug_weights = <%= @drug_weights.to_json %>;
      var unfinished_drugs = [];
      var sieved = [];
      var sievable = [];
      var activeField = ""

      var drugs_hash = {};
      var total_rows = 2;
      var addedRowsHash = {};
      
      var imgBlank = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAhHpUWHRSYXcgcHJvZmlsZSB0eXBlIGV4aWYAAHjadY7LCYBADAXvW4Ul5Lf5lCOiYAeWb8Kqe3IOyeMRhrT9Oo+2FAjUpJtrqEIiIUFrBocBAyAB1s45eDZjJpp1YxpBww1kHsrTv3RW18PETLtuulHaaWdkz1miskK9EVPyOfinf7+4AUCRLBT7Z5tUAAAKAmlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iWE1QIENvcmUgNC40LjAtRXhpdjIiPgogPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgeG1sbnM6ZXhpZj0iaHR0cDovL25zLmFkb2JlLmNvbS9leGlmLzEuMC8iCiAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyIKICAgZXhpZjpQaXhlbFhEaW1lbnNpb249IjMyIgogICBleGlmOlBpeGVsWURpbWVuc2lvbj0iMzIiCiAgIHRpZmY6SW1hZ2VXaWR0aD0iMzIiCiAgIHRpZmY6SW1hZ2VIZWlnaHQ9IjMyIgogICB0aWZmOk9yaWVudGF0aW9uPSIxIi8+CiA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgCjw/eHBhY2tldCBlbmQ9InciPz4NhXU1AAAABHNCSVQICAgIfAhkiAAAAeZJREFUWMPt1j1rVEEUxvH/3Nddb9ZEC4sIFhpFgiFiULATrCwEC4soamU6Se+XEKz9ABFSWFgIlpZCrCxc1kLzVmQ17EtudvfOnDkWG9nCJsWFFN7TzBQD58fDGWZMwCwnWQEnXBWgAlSAChAd92Dr6w4agAim1+HuqZSHUcx1wI+GbAxGrGcNPqFgFBZuni8XoAE4x/Swz6vFBZ5YQ9I9QL1gzqXcjjzPvzV5Eya8DEPy0hMQIRj2eb24xLPNPczBAFwBzoEXSELSS3O8aDUxWmMV0FJnoNfh3vw1Hv/cg/4hagvUObAWLUZopwfft+DKZVYGOXdKH8LTGU9HSpwPQCxGHMba8d45jLPQ7WO6OWlWZ7l0QFzjVqc3if2oOc6BsyAyXtv7EIYslT4D6gmsm8Qu9gjh0L/NvXj1EkBIWHoCg5yNqRQjbhK7uPG1dBbjxeNFzEwDI8KX0gEjy9ssRkLzb+xePM4J9TTmTAPbz1kvHZCkvNv8wfuLs5BEqDh0jPDqRTSrxczPoTu7rKU1PpY+A3GEyw9Z2d3CXb3Ag98dovY+igZmphFwdhq7vc1a4VlNInzpAKNQS/lVFDxqtrg/VWc5S7iBosWAz802a0nChzTGB+b4b4GpfsUVoAJUgP8e8Ad1/Pn3B4MjXwAAAABJRU5ErkJggg=='
      var imgTick = 'data:image/png;base64,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';
      var styles = "div { -moz-user-select: none;} .dbutton {font-size: 1em;padding: 10px;min-width: 120px;cursor: pointer;min-height: 55px;border-radius: 10px !important;margin: 3px;} .input_cell {font-size: 1.2em;padding:10px;border: 1px solid #3465a4;border-radius: 10px;width: 80% !important;} .buttttton {font-size: 1em;padding: 15px;min-width: 100px;  cursor: pointer;  min-height: 60px;border-radius: 10px !important;margin: 3px;}.bluee{border:1px solid #7eb9d0; -webkit-border-radius: 3px; -moz-border-radius: 3px;border-radius: 3px;font-size:28px;font-family:arial, helvetica, sans-serif; padding: 10px 10px 10px 10px; text-decoration:none; display:inline-block;text-shadow: -1px -1px 0 rgba(0,0,0,0.3);font-weight:bold; color: #FFFFFF;background-color: #a7cfdf; background-image: -webkit-gradient(linear, left top, left bottom, from(#a7cfdf), to(#23538a));background-image: -webkit-linear-gradient(top, #a7cfdf, #23538a);background-image: -moz-linear-gradient(top, #a7cfdf, #23538a);background-image: -ms-linear-gradient(top, #a7cfdf, #23538a);background-image: -o-linear-gradient(top, #a7cfdf, #23538a);background-image: linear-gradient(to bottom, #a7cfdf, #23538a);filter:progid:DXImageTransform.Microsoft.gradient(GradientType=0,startColorstr=#a7cfdf, endColorstr=#23538a);} .buttttton:active {border:1px solid #5ca6c4 !important;background-color: #82bbd1 !important; background-image: -webkit-gradient(linear, left top, left bottom, from(#82bbd1), to(#cd8912)) !important;background-image: -webkit-linear-gradient(top, #82bbd1, #cd8912) !important;background-image: -moz-linear-gradient(top, #efb144, #cd8912) !important;background-image: -ms-linear-gradient(top, #efb144, #cd8912) !important;background-image: -o-linear-gradient(top, #efb144, #cd8912) !important;background-image: linear-gradient(to bottom, #efb144, #cd8912) !important;filter:progid:DXImageTransform.Microsoft.gradient(GradientType=0,startColorstr=#efb144, endColorstr=#cd8912) !important;} .butt {  font-size: 26px;  padding: 15px 15px 6px 10px !important; text-align: center; max-width: 40px;  cursor: pointer;  max-height: 40px !important;  border-radius: 10px !important;  margin: 3px;} .butt:active {background-color: #f3e7c0;} .bluee{   border:1px solid #7eb9d0; -webkit-border-radius: 3px; -moz-border-radius: 3px;border-radius: 3px;font-size:28px;font-family:arial, helvetica, sans-serif; text-decoration:none; display:inline-block;text-shadow: -1px -1px 0 rgba(0,0,0,0.3);font-weight:bold; color: #FFFFFF;   background-color: #a7cfdf; background-image: -webkit-gradient(linear, left top, left bottom, from(#a7cfdf), to(#23538a));   background-image: -webkit-linear-gradient(top, #a7cfdf, #23538a);   background-image: -moz-linear-gradient(top, #a7cfdf, #23538a);   background-image: -ms-linear-gradient(top, #a7cfdf, #23538a);   background-image: -o-linear-gradient(top, #a7cfdf, #23538a);   background-image: linear-gradient(to bottom, #a7cfdf, #23538a);filter:progid:DXImageTransform.Microsoft.gradient(GradientType=0,startColorstr=#a7cfdf, endColorstr=#23538a);}.bluee:hover{   border:1px solid #5ca6c4;   background-color: #82bbd1; background-image: -webkit-gradient(linear, left top, left bottom, from(#82bbd1), to(#193b61));   background-image: -webkit-linear-gradient(top, #82bbd1, #193b61);   background-image: -moz-linear-gradient(top, #82bbd1, #193b61);   background-image: -ms-linear-gradient(top, #82bbd1, #193b61);   background-image: -o-linear-gradient(top, #82bbd1, #193b61);   background-image: linear-gradient(to bottom, #82bbd1, #193b61);filter:progid:DXImageTransform.Microsoft.gradient(GradientType=0,startColorstr=#82bbd1, endColorstr=#193b61);}.gray{   border:1px solid #ccc; -webkit-border-radius: 3px; -moz-border-radius: 3px;border-radius: 3px;font-size:28px;font-family:arial, helvetica, sans-serif; padding: 10px 10px 10px 10px; text-decoration:none; display:inline-block;text-shadow: -1px -1px 0 rgba(0,0,0,0.3);font-weight:bold; color: #FFFFFF;   background-color: #ccc; background-image: -webkit-gradient(linear, left top, left bottom, from(#ccc), to(#999));   background-image: -webkit-linear-gradient(top, #ccc, #999);   background-image: -moz-linear-gradient(top, #ccc, #999);   background-image: -ms-linear-gradient(top, #ccc, #999);   background-image: -o-linear-gradient(top, #ccc, #999);   background-image: linear-gradient(to bottom, #ccc, #999);filter:progid:DXImageTransform.Microsoft.gradient(GradientType=0,startColorstr=#ccc, endColorstr=#999);}.gray:hover{   border:1px solid #ccc;   background-color: #ddd; background-image: -webkit-gradient(linear, left top, left bottom, from(#333), to(#ccc));   background-image: -webkit-linear-gradient(top, #333, #ccc);   background-image: -moz-linear-gradient(top, #333, #ccc);   background-image: -ms-linear-gradient(top, #333, #ccc);   background-image: -o-linear-gradient(top, #333, #ccc);   background-image: linear-gradient(to bottom, #333, #ccc);filter:progid:DXImageTransform.Microsoft.gradient(GradientType=0,startColorstr=#333, endColorstr=#ccc);}.layer1 {position: absolute; top: 0px; left: 0px; border: 0px solid #000; width: 115%; height: 50%; z-index: 101; background-color: #4a7ced;}.layer2 {position: absolute; top: 40px; left: 0px; border: 0px solid #000; width: 115%; height: 50%; border:0px solid; border-top-right-radius: 1000px; z-index: 102; background-color: #fff;}.layer3 {position: absolute; top: 0px; left: 0px; border: 0px solid #000; width: 134%; height: 95%; border:0px solid; border-bottom-right-radius: 1000px; z-index: 99; background-color: #ff8010;}.layer4 {position: absolute; top: -4px; left: 0px; border: 0px solid #000; width: 130%; height: 95%; border:0px solid; border-bottom-right-radius: 1000px; z-index: 100; background-color: #fff;}.layer5 {position: absolute; top: 0px; left: 0px; border: 1px solid #000; width: 100%; height: 100%; overflow: hidden; background-color: rgba(255,255,255,0.2); z-index: 105;}.table1 {display: table; width: 100%; border-spacing: 10px;}.table2 {display: table; width: 95%; margin-left: 15px; border-spacing: 0px; margin-top: 10px;}.table3 {display: table; border-spacing: 5px; width: 100%;}.table4 {display: table; width: 98%; border-spacing: 1px; margin: 15px; height: 68%;}.table5 {display: table-cell; border-radius: 5px; border: 2px inset rgb(73,93,135); background-color: rgba(255,255,255,0.85); height: 100%;}.table6 {display: table; width: 215px;}.row {display: table-row;}.cell1 {display: table-cell; width: 520px; border-radius: 10px; border: 2px inset #495d87; border-bottom-left-radius: 150px; background-color: rgba(255,255,255,0.85); height: 120px;}.cellGender {display: table-cell; background-color: #c9d4ec; border-radius: 30px; padding: 5px; border: 2px solid #495d87; width: 30px; height: 30px;}.cell2 {display: table-cell; font-weight: bold; font-size: 24px; vertical-align: middle; border-bottom: 1px solid #999; padding-left: 10px;}.cell {display: table-cell;}.cell3 {display: table-cell; font-weight: bold; font-size: 12px; width: 120px;}.cell4 {display: table-cell; font-size: 12px;}.cell5 {display: table-cell; font-weight: bold; font-size: 12px; width: 100px;}.cell6 {display: table-cell; font-weight: bold; font-size: 12px;}.cell7 {display: table-cell; font-weight: bold; font-size: 12px;}.cell8 {display: table-cell; border-radius: 10px; border: 2px inset #495d87; background-color: rgba(255,255,255,0.85); border-top-right-radius: 150px;}.cell9 {display: table-cell; border: 1px ridge #eee; border-bottom-left-radius: 150px; border-top-right-radius: 150px; background-color: rgba(73,93,135,0.95); width: 200px; vertical-align: middle; text-align: center;}.div1 {font-size: 18px; color: #fff; font-family: Arial; margin: auto; }.div2 {width: 100%; height: 80px; position: absolute; bottom: 2px; left: 0px; z-index: 120; background-color: rgba(73,93,135,0.3); border-radius: 60px;}.frame1 {width: 100%; height: 100%; border: 0px solid #000;}.cell10 {display: table-cell; width: 220px; border: 0px ridge #ccc; border-bottom-right-radius: 60px; vertical-align: top;} .butt:active {border:1px solid #5ca6c4 !important;background-color: #82bbd1 !important; background-image: -webkit-gradient(linear, left top, left bottom, from(#82bbd1), to(#cd8912)) !important;background-image: -webkit-linear-gradient(top, #82bbd1, #cd8912) !important;background-image: -moz-linear-gradient(top, #efb144, #cd8912) !important;background-image: -ms-linear-gradient(top, #efb144, #cd8912) !important;background-image: -o-linear-gradient(top, #efb144, #cd8912) !important;background-image: linear-gradient(to bottom, #efb144, #cd8912) !important;filter:progid:DXImageTransform.Microsoft.gradient(GradientType=0,startColorstr=#efb144, endColorstr=#cd8912) !important;} .empty {border: 1px solid #ccc;border-radius: 15px;width: 180px;height: 150px;float: left;margin: 10px;}.menubutton {border: 1px solid #3465a4;border-radius: 15px;width: 180px;height: 150px;float: left;margin: 10px;cursor: pointer;vertical-align: middle; text-align: center;}.menubutton:hover {background-color: #c2d3f4;color: #0e2a64;text-decoration: underline;}.menubutton:active {background-color: #f3e7c0;}#pageTitle:hover {color: #999 !important;} .base {width: 100%; height: 100%; border: 1px solid #000; position: absolute; left: 0px; top: 0px; background-color: #fff; } ";
      var imgUnTick = 'data:image/png;base64,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';

      var mappedData = {
        "delivery_date": delivery_date,
        "drugs": drugs,
        "formatted_drugs": formatted_drugs,
        "drug_short_names": drug_short_names,
        "selected_drugs": selected
      }

      var check = false;
      months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

      monthNames = {
        "Jan": 0,
        "Feb": 1,
        "Mar": 2,
        "Apr": 3,
        "May": 4,
        "Jun": 5,
        "Jul": 6,
        "Aug": 7,
        "Sep": 8,
        "Oct": 9,
        "Nov": 10,
        "Dec": 11
      };

      var Entries = (function (jQ, data) {

        function guiSetup() {

          var style = document.createElement("style");
          style.innerHTML = styles;

          document.head.appendChild(style);

          var table = document.createElement("div");
          var headerTable = document.createElement("div");
          var header = document.createElement("div");
          var contentRow = document.createElement("div");
          var leftPane = document.createElement("div");
          var rightPane = document.createElement("div");
          var headerTitle1 = document.createElement("div");
          var headerTitle2 = document.createElement("div");
          var div = document.createElement("div");
          var div2 = document.createElement("div");

          headerTable.id = "h-table";
          headerTitle1.id = "ht1";
          headerTitle2.id = "ht2";

          headerTitle1.innerHTML = "Item";
          headerTitle2.innerHTML = "Item Stock Details";

          table.id = "table";
          contentRow.id = "c-row";
          header.className = "h-row";

          contentRow.className = "c-row t-row";
          leftPane.id = "left";

          div.id = "drug-pane";
          div.innerHTML = "<div id = 'drug-list'></div>";
          leftPane.appendChild(div);
          div2.id = "data-pane";
          rightPane.appendChild(div2);

          rightPane.id = "right";
          leftPane.className = "t-data";
          rightPane.className = "t-data";
          headerTitle1.className = "h-data";
          headerTitle2.className = "h-data";

          header.appendChild(headerTitle1);
          header.appendChild(headerTitle2);

          contentRow.appendChild(leftPane);
          contentRow.appendChild(rightPane);

          headerTable.appendChild(header);
          table.appendChild(contentRow);

          jQ("#inputFrame" + tstCurrentPage).empty();
          __$("inputFrame" + tstCurrentPage).appendChild(headerTable);
          __$("inputFrame" + tstCurrentPage).appendChild(table);

          loadCSS();
        }

        function loadCSS() {

          jQ(".h-row").css({
            background: "#999",
            "border-radius": "5px",
            width: "100%"
          })

          jQ("#drug-pane").css({
            position: "absolute",
            "top": "122px",
            height: "520px",
            "max-height": "520px",
            border: "1px solid lightgray",
            "border-right": "2.25px solid lightblue",
            "box-shadow": "inset 0 0 30px lightblue, 0 0 8px black",
            width: (0.33 * window.innerWidth) + "px"
          })

          jQ("#data-pane").css({
            position: "absolute",
            background: "rgb(250, 250, 250)",
            "top": "122px",
            height: "520px",
            "box-shadow": "inset 0 0 30px lightgray, 0 0 10px white",
            "max-height": "520px",
            "overflow": "auto",
            border: "1px solid lightgray",
            "border-left": "2.25px solid lightblue",
            width: (0.576 * window.innerWidth) + "px",
            left: (0.372 * window.innerWidth) + "px"
          })

          jQ("#drug-pane, #ht1, #left").css({
            width: (0.33 * window.innerWidth) + "px"
          })

          var width = __$("c-row").offsetWidth + "px";

          __$("h-table").style.width = width;

        }

        function loadDrugs() {

          var all_drugs = data["selected_drugs"];
          var short_names = data["drug_short_names"];
          var cms_names = data["drug_cms_names"];

          __$("drug-list").style.display = "table";

          for (var k in all_drugs) {

            var r = document.createElement("div");
            r.className = "drug-row";
            r.style.display = "table-row";

            var div = document.createElement("div");
            div.style.display = "table-cell";
            var img = document.createElement("img");
            img.id = all_drugs[k] + "_img";
            img.className = "img";
            div.style.minWidth = "35px";
            img.src = imgBlank;
            div.appendChild(img);

            img.style.maxHeight = "35px";
            r.appendChild(div);

            var li = document.createElement("div");
            li.style.display = "table-cell";
            li.innerHTML = short_names[all_drugs[k]];
            li.id = all_drugs[k];

            li.setAttribute("value", all_drugs[k]);
            li.setAttribute("cms_name", drug_cms_names[all_drugs[k]]);

            li.style.background = (k % 2 == 0) ? "rgb(245, 250, 253)" : "white";
            li.className = (k % 2 == 0) ? "even" : "odd";
            li.onmousedown = function () {
              clickUpdate(this, "drug-list");
            }

            r.appendChild(li);
            __$("drug-list").appendChild(r);
          }

          for (var j in drugs) {
            buildParams(drugs[j]);
          }
        }

        function loadControls(item, pos) {
          __$("data-pane").setAttribute("pos", pos);
          __$("data-pane").setAttribute("drug", item.getAttribute("value"));

          /* CUSTOM TABLE FOR BATCH DETAILS*/
          var scrollable_div = document.createElement("div");
          scrollable_div.id = 'scrollable-div';
          scrollable_div.style.overflow = "auto";
          scrollable_div.style.height = "250px";
          scrollable_div.style.paddingTop = "15px";

          var tbl     = document.createElement("table");
          tbl.id = "batch-table"
          //tbl.style.position = "absolute";
          tbl.style.border = "1.5px solid #5ca6c4";
          tbl.style.borderRadius = "10px";
          tbl.style.width = "94%";
          //tbl.style.paddingLeft = "20px";
          tbl.style.marginTop = "20px";
          tbl.style.marginLeft = "20px";
          tbl.style.paddingTop = "35px";
          tbl.style.paddingBottom = "20px";
  

          table_headers = ["Tabs Per Tin", "Total Usable Tins", "Earliest Expiry Date", "Number of expiring tins"];

          var th_row = document.createElement("tr");
          drg = item.getAttribute("value");
          rows_count = 2;
          if ( typeof addedRowsHash[drg] != "undefined"){
            rows_count = rows_count + parseInt(addedRowsHash[drg]);
          }

          for (var i=0; i<=3; i++){
            var th = document.createElement("th");
            th.style.width = '10%';
            var thText = document.createTextNode(table_headers[i]);
            th.appendChild(thText);
            th_row.appendChild(th);
          }
          tbl.appendChild(th_row)

          var tblBody = document.createElement("tbody");
          rows_count = 1;
          for (var i = 0; i < rows_count; i++) {
            var row = document.createElement("tr");
            var drug_name = item.getAttribute("value") + "_" + i;
            for (var j = 0; j <= 3; j++) {
              var cell = document.createElement("td");
              cell.style.width = '80px';
              cell.style.textAlign = 'center';
              var textField = document.createElement("input");
              if (j == 0){
                //var inputID = "Number of tins";
                var inputID = item.getAttribute("value") + "_" + i + "_number_of_tins";

                /*if (i == 0){
                  var inputValue = drug_cms_packsizes[item.getAttribute("value")];
                }else{
                  var inputValue = drugs_hash[drug_name]["tabs_per_tin"]
                }*/
                var inputValue = drug_cms_packsizes[item.getAttribute("value")];
                var field_type = "tabs_per_tin";
              }

              if (j == 1){
                //var inputID = "Number of expiring tins";
                var inputID = item.getAttribute("value") + "_" + i + "_total_tins";

                var inputValue = drugs_hash[drug_name]["total_tins"] //__$(item.getAttribute("value") + "_expire_amount_" + pos).value;
                var field_type = "total_tins"
              }

              if (j == 2){
                //var inputID = "Date of expiry";
                var inputID = item.getAttribute("value") + "_" + i + "_date_of_expiry";

                var inputValue = drugs_hash[drug_name]["date_of_expiry"]; //__$(item.getAttribute("value") + "_date_" + pos).value;
                var field_type = "date_of_expiry"
              }

              if (j == 3){
                //var inputID = "Date of expiry";
                var inputID = item.getAttribute("value") + "_" + i + "_expiring_tins";

                var inputValue = drugs_hash[drug_name]["expiring_tins"]; //__$(item.getAttribute("value") + "_date_" + pos).value;
                var field_type = "expiring_tins"
              }
              
              textField.className = "input-field";
              textField.id = inputID;
              textField.value = inputValue;
              textField.setAttribute("field_type", field_type)
              textField.setAttribute("row", i);
              textField.setAttribute("drug_name", item.getAttribute("value") + "_" + i)
              textField.style.height = '35px';
              textField.style.width = '264px';
              textField.style.fontSize = '26px';
              textField.style.marginLeft = '10px';
              textField.style.textAlign = 'center';

              if (i + j == 0){
                textField.disabled = true;
              }
              if (j != 2){
                textField.onmousedown = function () {
                  jQ(".input-field").attr("class", "input-field");
                  this.className += " input-field-active";
                  if (__$('popupkeyboard'))
                    __$('data-pane').removeChild(__$('popupkeyboard'));
                  showKeyboard(this);
                }
              }else{
                textField.onmousedown = function () {
                  jQ(".input-field").attr("class", "input-field");
                  this.className += " input-field-active";
                  if (__$('popupkeyboard'))
                    __$('data-pane').removeChild(__$('popupkeyboard'));
                  showDate(__$('data-pane'), this);
                }
              }

              cell.appendChild(textField);
              row.appendChild(cell);
            }
            tblBody.appendChild(row);
            tbl.appendChild(tblBody);
          }
          scrollable_div.appendChild(tbl)
          __$("data-pane").appendChild(scrollable_div);
          jQuery("#batch-table td:first-child, #batch-table th:first-child").hide();
          /* CUSTOM END*/

          var table = document.createElement("div");
          table.style.paddingLeft = "25px";
          var header = document.createElement("div");
          var rowA = document.createElement("div");
          table.style.display = 'table';
          table.id = "input-table";
          table.style.width = "90%";
          //table.style.marginTop = "20%";
          table.style.borderRadius = "8px";
          table.style.marginLeft = "25px";
          table.style.marginBottom = "7px";
          table.style.border = '1.5px solid #5ca6c4';
          table.style.borderRadius = '10px';

          header.id = "input-header";
          header.style.width = "98%";
          header.style.textAlign = "center";
          header.style.height = "45px";
          header.style.top = "0px";
          header.style.position = 'absolute';
          header.setAttribute("drug", item.getAttribute("value"));
          /*header.innerHTML = pos + (pos == 1 ? "<sup>st</sup>" : (pos == 2 ? "<sup>nd</sup>" : (pos == 3 ? "<sup>rd</sup>" : "th"))) +
                        " - " + item.getAttribute("cms_name");*/
          header.innerHTML = item.getAttribute("cms_name");
          scrollable_div.appendChild(header)
          //__$("data-pane").appendChild(header);
          __$("data-pane").appendChild(table);


          var button = document.createElement("div");
          button.id = "add-button";
          button.innerHTML = "<span>Add Row</span>";
          button.setAttribute("drug", item.getAttribute("value"));
          button.onmousedown = function () {
            addNewRow();
          }
          //__$("data-pane").appendChild(button);



          /*if (!(sieved.indexOf(item.getAttribute("value")) >= 0)) {
            console.log("Sieved data found")
            var textField1 = document.createElement("input");
            textField1.id = "Number of tins";
            textField1.setAttribute("label", "Tabs Per Tin");
            textField1.className = "input-field input-field-active";
            textField1.value = drug_cms_packsizes[item.getAttribute("value")];
            textField1.disabled = true;
            textField1.onmousedown = function () {
              target = this;
              jQ(".input-field").attr("class", "input-field");
              this.className += " input-field-active";

              if (__$('popupkeyboard'))
                __$('data-pane').removeChild(__$('popupkeyboard'));
              showKeyboard(this);
            }

            table.appendChild(wrap(textField1));
          } else {

            var textField1 = document.createElement("select");
            textField1.id = "Number of expiring tins";
            textField1.setAttribute("label", "Tabs Per Tin");
            textField1.innerHTML = "<option>" + drug_cms_packsizes[item.getAttribute("value")] + "</option>";
            textField1.disabled = true;
            textField1.style.background = "white";
            textField1.className = "input-field input-field-active";
            textField1.value = __$(item.getAttribute("value") + "_expire_amount_" + pos).value;
            textField1.onmousedown = function () {
              target = this;
              jQ(".input-field").attr("class", "input-field");
              this.className += " input-field-active";
              if (__$('popupkeyboard'))
                __$('data-pane').removeChild(__$('popupkeyboard'));
            }

            table.appendChild(wrap(textField1));
          }

          if (!(sieved.indexOf(item.getAttribute("value")) >= 0)) {
            var textField2 = document.createElement("input");
            textField2.id = "Number of expiring tins";
            textField2.setAttribute("label", "Total tins");
            textField2.className = "input-field";
            textField2.value = __$(item.getAttribute("value") + "_expire_amount_" + pos).value;
            textField2.onmousedown = function () {
              target = this;
              jQ(".input-field").attr("class", "input-field");
              this.className += " input-field-active";

              if (__$('popupkeyboard'))
                __$('data-pane').removeChild(__$('popupkeyboard'));
              showKeyboard(this);
            }
          } else {

            var textField2 = document.createElement("input");
            textField2.id = "Number of tins";
            textField2.setAttribute("label", "Total units");
            textField2.className = "input-field";
            textField2.value = __$(item.getAttribute("value") + "_amount_" + pos).value;
            textField2.onmousedown = function () {
              target = this;
              jQ(".input-field").attr("class", "input-field");
              this.className += " input-field-active";

              if (__$('popupkeyboard'))
                __$('data-pane').removeChild(__$('popupkeyboard'));
              showKeyboard(this);
            }

          }
          table.appendChild(wrap(textField2));

          var textField3 = document.createElement("input");
          textField3.id = "Date of expiry";
          textField3.className = "input-field";
          textField3.value = __$(item.getAttribute("value") + "_date_" + pos).value;
          textField3.onmousedown = function () {

            jQ(".input-field").attr("class", "input-field");
            this.className += " input-field-active";
            if (__$('popupkeyboard'))
              __$('data-pane').removeChild(__$('popupkeyboard'));
            showDate(__$('data-pane'), this);
          }

          table.appendChild(wrap(textField3));

          if (!(sieved.indexOf(item.getAttribute("value")) >= 0))
            showKeyboard(textField1);

          var button = document.createElement("div");
          button.id = "add-button";
          button.innerHTML = "<span>+</span>";
          button.setAttribute("drug", item.getAttribute("value"));
          button.onmousedown = function () {

            if (unfinished_drugs.indexOf(this.getAttribute("drug")) >= 0) {

              showMessage(("Finish entries for drug: " + this.getAttribute("drug")), false, false);
            } else {

              jQ("#data-pane").slideToggle();

              buildParams(this.getAttribute("drug"), (counts[this.getAttribute("drug")] + 1))
              counts[this.getAttribute("drug")] += 1;
              jQ("#data-pane").empty();

              loadControls(__$(this.getAttribute("drug")), counts[this.getAttribute("drug")]);
              __$("add-button").style.display = "none";
              jQ("#data-pane").slideToggle();
              __$("add-button").style.display = "block";
              refresh(this.getAttribute("drug"));
            }
          }
          __$("data-pane").appendChild(button);
          if (activeField.length > 0) {
            __$(activeField).onmousedown.apply(__$(activeField));
            activeField = "";
          }*/
        }

        function showDate(parent, target) {

          date = new Date();
          date = new Date(date.getFullYear(), (date.getMonth() + 1), 0);

          months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

          monthNames = {
            "Jan": 0,
            "Feb": 1,
            "Mar": 2,
            "Apr": 3,
            "May": 4,
            "Jun": 5,
            "Jul": 6,
            "Aug": 7,
            "Sep": 8,
            "Oct": 9,
            "Nov": 10,
            "Dec": 11
          };

          var tbl = document.createElement("div");
          tbl.style.display = "table";
          tbl.id = "popupkeyboard";
          tbl.style.marginTop = "25px";
          tbl.style.marginLeft = "33%";
          tbl.style.borderSpacing = "5px";

          parent.appendChild(tbl);

          var cells = [
            [
              {
                "type": "button",
                "id": "btnAddYearFor" + target.id,
                "target": target.id,
                "value": "+",
                "onmousedown": "incrementYear(this.getAttribute('target'))",
                "class": "dbutton bluee",
                "style": "height: 60px; margin: auto; width: 100%;"
              },
              {
                "type": "button",
                "id": "btnAddMonthFor" + target.id,
                "target": target.id,
                "value": "+",
                "onmousedown": "incrementMonth(this.getAttribute('target'))",
                "class": "dbutton bluee",
                "style": "height: 60px; margin: auto; width: 100%; margin-left: 20px;"
              },
              {
                "type": "button",
                "id": "btnAddDateFor" + target.id,
                "target": target.id,
                "value": "+",
                "onmousedown": "incrementDate(this.getAttribute('target'))",
                "class": "dbutton bluee",
                "style": "display: none; height: 60px; margin: auto; width: 100%;"
              }
            ],
            [
              {
                "type": "input",
                "id": "txtYearFor" + target.id,
                "target": target.id,
                "value": date.getFullYear(),
                "onmousedown": "overwriteNumber = true; if(__$('keyboard')){document.body.removeChild(__$('keyboard'));} else {showShield(\"checkDate('\" + this.getAttribute('target') + \"', false)\"); showKeyboard(__$('txtYearFor' + this.getAttribute('target')),{':':':','/':'/','.':'.','abc':'abc'},true);} checkDate(this.getAttribute('target'));",
                "class": "input_cell",
                "style": "font-size: 24px; text-align: center; width: 100%;"
              },
              {
                "type": "input",
                "id": "txtMonthFor" + target.id,
                "target": target.id,
                "value": months[date.getMonth()],
                "onmousedown": "showShield(); addList(__$('txtMonthFor' + this.getAttribute('target')),{'Jan':'January','Feb':'February','Mar':'March','Apr':'April','May':'May','Jun':'June','Jul':'July','Aug':'August','Sep':'September','Oct':'October','Nov':'November','Dec':'December','?':'Unknown'},'single',__$('txtMonthFor' + this.getAttribute('target')),__$('txtMonthFor' + this.getAttribute('target')), 'checkDate(\"' + this.getAttribute('target') + '\")'); checkDate(this.getAttribute('target'));",
                "class": "input_cell",
                "style": "font-size: 24px; text-align: center; width: 100%; margin-left: 23px; "
              },
              {
                "type": "input",
                "id": "txtDateFor" + target.id,
                "target": target.id,
                "value": date.getDate(),
                "onmousedown": "overwriteNumber = true; if(__$('keyboard')){document.body.removeChild(__$('keyboard'));} else {showShield(\"checkDate('\" + this.getAttribute('target') + \"', false)\"); showKeyboard(__$('txtDateFor' + this.getAttribute('target')),{':':':','/':'/','.':'.','abc':'abc'},true);} checkDate(this.getAttribute('target'));",
                "class": "input_cell",
                "style": "display: none; font-size: 24px; text-align: center; width: 100%;"
              }
            ],
            [
              {
                "type": "button",
                "id": "btnSubtractYearFor" + target.id,
                "target": target.id,
                "value": "-",
                "onmousedown": "decrementYear(this.getAttribute('target'))",
                "class": "dbutton bluee",
                "style": "height: 60px; margin: auto; width: 100%;"
              },
              {
                "type": "button",
                "id": "btnSubtractMonthFor" + target.id,
                "target": target.id,
                "value": "-",
                "onmousedown": "decrementMonth(this.getAttribute('target'))",
                "class": "dbutton bluee",
                "style": "height: 60px; margin: auto; width: 100%; margin-left: 20px;"
              },
              {
                "type": "button",
                "id": "btnSubtractDateFor" + target.id,
                "target": target.id,
                "value": "-",
                "onmousedown": "decrementDate(this.getAttribute('target'))",
                "class": "dbutton bluee",
                "style": "display: none; height: 60px; margin: auto; width: 100%;"
              }
            ]
          ];

          for (var i = 0; i < cells.length; i++) {
            var row = document.createElement("div");
            row.style.display = "table-row";

            tbl.appendChild(row);

            for (var j = 0; j < cells[i].length; j++) {
              var cell = document.createElement("div");
              cell.style.display = "table-cell";
              cell.style.width = "140px";
              cell.style.textAlign = "center";

              row.appendChild(cell);

              var input = document.createElement("input");

              for (var key in cells[i][j]) {
                input.setAttribute(key, cells[i][j][key]);
              }

              cell.appendChild(input);
            }
          }

          return tbl;
        }

        function wrap(node) {

          var row = document.createElement("div");
          row.style.display = "table-row";

          var label = document.createElement("label");
          label.className = "label";
          label.innerHTML = node.getAttribute("label") ? node.getAttribute("label") : node.id;
          var tdLabel = document.createElement("div");
          tdLabel.className = "td";
          tdLabel.style.paddingTop = "15px";
          tdLabel.style.height = "45px";
          tdLabel.style.display = "table-cell";
          tdLabel.appendChild(label);
          row.appendChild(tdLabel);

          var input = document.createElement("div");
          input.className = "td";
          input.style.display = "table-cell";
          node.style.fontSize = "24px";
          node.style.textAlign = "center";
          node.style.width = "275px";
          node.style.height = "35px";
          input.appendChild(node);
          row.appendChild(input);

          var img = document.createElement("img");
          img.style.height = "28px";
          img.src = imgUnTick;
          var clear = document.createElement("div");
          clear.className = "td";
          clear.style.width = "42px";
          clear.style.paddingRight = "20px";
          clear.style.cursor = "pointer";
          clear.style.display = "table-cell";
          clear.setAttribute("target", node.id)
          clear.appendChild(img);
          clear.onmousedown = function () {
            if (__$(this.getAttribute("target")).disabled != true)
              __$(this.getAttribute("target")).value = "";
          };

          row.appendChild(clear);

          return row;
        }

        function clickUpdate(node, id) {

          var evens = document.getElementsByClassName("even");
          var odds = document.getElementsByClassName("odd");

          for (var i = 0; i < evens.length; i++) {
            evens[i].style.background = "rgb(245, 250, 253)";
          }

          for (var i = 0; i < odds.length; i++) {
            odds[i].style.background = "white";
          }

          node.style.background = "lightblue";

          jQ("#data-pane").empty();
          setTimeout(function () {
            loadControls(node)
          }, 100);
        }

        function buildParams(drug) {

          if (!__$(drug + "_amount")) {

            var input0 = document.createElement("input");
            input0.id = drug + "_pills_per_tin";
            input0.setAttribute("type", "hidden");
            input0.setAttribute("name", "obs[" + drug + "][pills_per_tin]");

            var input1 = document.createElement("input");
            input1.id = drug + "_amount";
            input1.setAttribute("type", "hidden");
            input1.setAttribute("name", "obs[" + drug + "][amount]");

            var input2 = document.createElement("input");
            input2.id = drug + "_expire_amount";
            input2.setAttribute("name", "obs[" + drug + "][expire_amount]");

            var input3 = document.createElement("input");
            input3.id = drug + "_date";
            input3.setAttribute("name", "obs[" + drug + "][date]");

            var form = document.forms[0]
            form.appendChild(input0);
            form.appendChild(input1);
            form.appendChild(input2);
            form.appendChild(input3);
          }
        }

        function updateParams(drug_name) {

          try {
            __$(drug_name + "_pills_per_tin").value = __$("Pills per tin").value;
          } catch (x) {
          }

          try {
            __$(drug_name + "_amount").value = __$("Number of tins").value;
          } catch (x) {
          }

          try {
            __$(drug_name + "_expire_amount").value = __$("Number of expiring tins").value;
          } catch (x) {
          }

          try {
            __$(drug_name + "_date").value = __$("Date of expiry").value;
          } catch (x) {
          }
        }

        function checkValidations() {

          if (!__$("data-pane"))
            return;

          var all_drugs = data["selected_drugs"];
          var nodes = document.getElementsByClassName("butt");
          var node = __$("data-pane").childNodes[0]

          if (node)
            updateParams(node.getAttribute('value'));

          if (nodes.length > 0) {

            if (target.value.match(/\./) || target.value.trim().length == 0) {

              jQ(".butt").attr("class", "butt bluee");
              if (__$("."))
                __$(".").className = "butt gray";
            } else {
              if (__$("."))
                __$(".").className = "butt bluee";

              if (target.value == "0") {

                jQ(".butt").attr("class", "butt gray");
                __$("&larr;").className = "butt bluee";
                __$(".").className = "butt bluee";
              } else {

                jQ(".butt").attr("class", "butt bluee");
              }

            }

          }

          unfinished_drugs = [];
          for (var i in all_drugs) {

            var dname = all_drugs[i];
            var amount = __$(dname + "_amount").value.trim();
            var expire_amount = __$(dname + "_expire_amount").value.trim();
            var date = __$(dname + "_date").value.trim();

            if (amount.length > 0 && expire_amount.length > 0 && date.length > 0) {
              __$(dname + "_img").src = imgTick;
            } else {
              __$(dname + "_img").src = imgBlank;
              if (unfinished_drugs.indexOf(dname) < 0)
                unfinished_drugs.push(dname);
            }

          }

          setTimeout(function () {
            checkValidations();
          }, 250);
        }

        function showKeyboard(ctrl) {

          target = ctrl;

          var pos;
          numbers = true;
          var div = document.createElement('div');
          div.id = 'popupkeyboard';

          div.borderTop = "20px";
          div.style.zIndex = '1000';

          __$("data-pane").appendChild(div);

          var keys = [
            [1, 2, 3, '&larr;'],
            [4, 5, 6, 0],
            [7, 8, 9, '.']
          ];

          var table = document.createElement('div');
          table.style.display = 'table';
          table.style.margin = 'auto';

          div.appendChild(table);

          var ctrl;

          for (var i = 0; i < keys.length; i++) {
            var row = document.createElement('div');
            row.style.display = 'table-row';

            table.appendChild(row);

            for (var j = 0; j < keys[i].length; j++) {
              var cell = document.createElement('div');
              cell.style.display = 'table-cell';

              row.appendChild(cell);

              if (String(keys[i][j]).trim().length == 0) {
                cell.innerHTML = "&nbsp;";

                continue;
              }

              var button = document.createElement('div');
              button.style.width = '65px';
              button.style.height = '60px';
              button.style.minWidth = '40px';
              button.style.minHeight = '40px';
              button.style.margin = '2px';
              button.style.fontSize = "24px";

              button.id = keys[i][j];

              if (target && keys[i][j] == '.') {
                if (target.value.trim().match(/\./) || target.value.trim().length == 0) {
                  button.setAttribute('class', 'butt gray');
                } else {
                  button.setAttribute('class', 'butt bluee');
                }
              }

              button.innerHTML = keys[i][j];

              button.setAttribute('class', 'butt bluee');

              button.onmousedown = function () {

                if (!this.className.match(/gray/)) {
                  if (this.innerHTML.trim().charCodeAt(0) == 8592) {
                    if (target) {
                      target.value = target.value.trim().substring(0, (target.value.trim().length - 1));
                    }
                  } else {

                    target.value += this.innerHTML.trim();

                  }
                }
              }

              cell.appendChild(button);
            }
          }

        }

        return{
          initialize: function () {

            guiSetup();
            loadDrugs();
            //checkValidations();
          }
        };

      })(jQuery, mappedData);

      //*********************************** End of Module ****************************


      function incrementYear(id) {
        if (__$("txtYearFor" + id)) {
          var yr = parseInt(__$("txtYearFor" + id).value.trim());

          yr++;

          __$("txtYearFor" + id).value = yr;

          checkDate(id);
        }
      }

      function decrementYear(id) {
        if (__$("txtYearFor" + id)) {
          var yr = parseInt(__$("txtYearFor" + id).value.trim());

          yr--;

          __$("txtYearFor" + id).value = yr;

          checkDate(id);
        }
      }

      function incrementMonth(id) {
        if (__$("txtMonthFor" + id)) {
          var month = monthNames[__$("txtMonthFor" + id).value.trim()];

          if (month + 1 < 12) {
            month++;
          } else {
            month = 0;
          }

          __$("txtMonthFor" + id).value = months[month];

          checkDate(id);
        }
      }

      function decrementMonth(id) {
        if (__$("txtMonthFor" + id)) {
          var month = monthNames[__$("txtMonthFor" + id).value.trim()];

          if (month - 1 >= 0) {
            month--;
          } else {
            month = 11;
          }

          __$("txtMonthFor" + id).value = months[month];

          checkDate(id);
        }
      }

      function checkDate(id) {

        if (__$("txtDateFor" + id) && __$("txtYearFor" + id) && __$("txtMonthFor" + id)) {


          if (__$("txtMonthFor" + id).value.trim() == "?") {

            __$("txtMonthFor" + id).value = "?";

            __$("txtDateFor" + id).value = "?";

            if (__$(id)) {

              __$(id).value = __$("txtDateFor" + id).value.trim() + "/" + __$("txtMonthFor" + id).value.trim() + "/" + __$("txtYearFor" + id).value.trim();

            }

            return;

          }

          var value = parseInt(__$("txtDateFor" + id).value.trim());

          var month = monthNames[__$("txtMonthFor" + id).value.trim()];

          if (month + 1 < 12) {
            month += 2;
          } else {
            month = 1;
          }

          var date = new Date(__$("txtYearFor" + id).value.trim(), padZeros((month - 1), 2), 0);

          date.setDate(date.getDate());

          __$("txtDateFor" + id).value = date.getDate();

          if (__$(id)) {

            __$(id).value = __$("txtDateFor" + id).value.trim() + "/" + __$("txtMonthFor" + id).value.trim() + "/" + __$("txtYearFor" + id).value.trim();

          }

        } else {

          if (__$(id)) {

            var value = parseInt(__$("txtDateFor" + id).value.trim());

            var month = monthNames[__$("txtMonthFor" + id).value.trim()];

            if (month + 1 < 12) {
              month += 2;
            } else {
              month = 1;
            }

            var date = new Date(__$("txtYearFor" + id).value.trim(), padZeros(month, 2), 0)

            date.setDate(date.getDate());

            __$("txtDateFor" + id).value = date.getDate();

            if (__$(id)) {

              __$(id).value = __$("txtDateFor" + id).value.trim() + "/" + __$("txtMonthFor" + id).value.trim() + "/" + __$("txtYearFor" + id).value.trim();

            }

            __$(id).value = __$("txtDateFor" + id).value.trim() + "/" + __$("txtMonthFor" + id).value.trim() + "/" + __$("txtYearFor" + id).value.trim();

          }

        }
      }

      function updateNextButton(){
        __$("nextButton").onmousedown = function(){

          var message = "";
          for (var i in unfinished_drugs){
            message += ("<br /> - " + drug_short_names[unfinished_drugs[i]] + (i < (unfinished_drugs.length - 1) ? "," : ""));
          }

          if(message.length > 0) {
            showMessage(("Incomplete entries for:" + message), false, false);
          }else{
            gotoNextPage();
          }
        }
      }

      function navigate(drug, field){

        if (__$("backButton"))
          __$("backButton").onmousedown.apply(__$("backButton"));

        if (__$(drug)) {

          activeField = field;
          __$(drug).onmousedown.apply(__$(drug))
        }
      }

      function checkContainer() {
        if (__$("inputFrame" + tstCurrentPage) && __$("inputFrame" + tstCurrentPage) != undefined) {

          Entries.initialize();
        } else {
          setTimeout("checkContainer()", 150);
        }
      }

      function enableSaveDialogBox(){
        __$('nextButton').onmousedown = function(){
          dispatchMessage("Are you sure you want to save these drugs", tstMessageBoxType.YesNo)
        }
      }

      function disableSaveDialogBox(){
        __$('nextButton').onmousedown = function(){
          gotoNextPage();
        }
      }

      window.onresize = function () {
        loadCSS();
      }

    </script>

    <style>


      .touchscreenTextInput {
        display: none;
      }

      #table, #h-table {
        display: table;
        width: 99%;
        padding-left: 0.7%;
        border-radius: 3px;
        border-spacing: 3px;
        font-size: 26px;
        border-collapse: separate;
      }

      .t-data, .h-data {
        display: table-cell;
      }

      .t-row {
        display: table-row;
      }

      .h-data {
        border-radius: 5px;
        height: 56px;
        color: white;
        font-size: 30px;
        font-family: sans-serif;
        font-weight: bold;
        text-shadow: 1px 1px black;
        vertical-align: middle;
        text-align: center;
      }

      #ht1 {
        border-right: 2.25px solid white;
      }

      #ht2 {
        border-left: 2.25px solid white;
        min-width: 350px;
      }

      #drug-pane, #data-pane {
        background: white;
        padding-left: 0px;
        border-radius: 5px;
      }

      #drug-pane {
        padding-left: 0px;
        overflow: auto;
        overflow-X: hidden;
      }

      #drug-list {
        list-style-type: none;
        font-size: 16px;
      }

      .even, .odd {
        font-size: 24px;
        padding-left: 10px;
        cursor: pointer;
        height: 43px;
        vertical-align: middle;
        font-weight: normal;
        -moz-user-select: none;
        border-bottom: 1px dotted;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        -o-text-overflow: ellipsis;
      }

      .input-field {
        -webkit-transition: all 0.30s ease-in-out;
        -moz-transition: all 0.30s ease-in-out;
        -ms-transition: all 0.30s ease-in-out;
        -o-transition: all 0.30s ease-in-out;
        outline: none;
        padding: 3px 0px 3px 3px;
        margin: 1px 1px 1px 0px;
        border: 1px solid #DDDDDD;
      }

      .input-field-active {
        box-shadow: 0 0 5px rgba(81, 203, 238, 1);
        padding: 3px 0px 3px 3px;
        margin: 1px 1px 1px 0px;
        border: 1px solid rgba(81, 203, 238, 1);
      }

      option {
        background: #E3E4FA;
        padding-bottom: 10px;
        border-radius: 4px;
        margin: 1px;
        text-shadow: 0 2px 0 rgba(0, 0, 0, 0.4);
      }

      .scell {
        height: 35px;
        font-size: 20px;
        border-bottom: 0.4px solid gray;
        border-right: 0.4px solid gray;
        border-radius: 4px;
        text-align: center;
        vertical-align: middle;
      }

      .drug-label {
        min-width: 16%;
        text-align: left;
        padding-left: 2%;
        overflow-X: hidden;
      }

      .drug-value {
        min-width: 16%;
        cursor: pointer;
      }

      .hvalue {
        border: hidden;
        background: white;
        font-size: 22px;
        font-family: sans-serif;
        font-weight: bold;
        cursor: auto;
        color: gray;
        text-align: left;
        padding-left: 9px;
        text-shadow: 1px 1px black;
        vertical-align: middle;
      }
      .editable{
        border-style: outset;
        border-left: 1px solid gray;
        border-top: 1px solid gray;
        background-color: #d3d3d3;
        border-radius: 3px;
      }

    </style>
  </head>
  <div id="container">
    <form action="stock_report_edit" method="post">

      <input type="hidden" name="delivery_date" value="<%= @delivery_date %>">
      <input type="hidden" name="type" value="<%= params['verification type'] %>">

      <%= text_field_tag :information, nil,
        {
        :tt_onLoad => "$('clearButton').style.display = 'none'; checkContainer(); updateNextButton() ",
        :optional => "true",
        :id => "input",
        :helpText => "#{((params['verification type'] || '') + ' drug').humanize} verification",
        :tt_pageStyleClass => "NoKeyboard"
      } %>

      <%= text_field_tag :showSummary, nil,
        {
        :tt_onLoad => "showSummaryX();enableSaveDialogBox();",
        :optional => "true",
        :id => "summary",
        :helpText => "<span style='color: red;background: white;'>Verify values entered</span>",
        :tt_pageStyleClass => "NoKeyboard"
      } %>
    </form>
  </div>
</html>

<script>

  function showSummaryX() {

    buildTable();

  }

  function buildTable() {
    table = document.createElement('table');
    table.setAttribute('class','summary-table');
    thead = document.createElement('thead');
    tr = document.createElement('tr');
    thead.appendChild(tr);
 
    ths = [
      ["text-align:left;","Items counted as"],
      ["text-align:right;","TINS"],
      ["","&nbsp"],
      ["text-align:right;","Previous stock"],
      ["text-align:right;","Total usable tins"],
      ["text-align:center;","Date&nbsp;MM/YY"],
      ["text-align:right;","Units expiring that date"]
    ]
  
    for(var i = 0; i < ths.length; i++) {
      th = document.createElement('th');
      th.setAttribute('style',ths[i][0]);
      th.innerHTML = ths[i][1];
      tr.appendChild(th);
    }
    table.appendChild(thead);

    tbody = document.createElement('tbody');
    tbody.setAttribute('id','section_one');
    section_one = 18; x = 1;

    while(x < section_one) {
      var total_usable_tins = "0";
      var expiry_date = "N/A";
      var units_expiring = "0";
      var date_value = "N/A";

      if(__$(drug_weights[x][1] + "_pills_per_tin")){
        var total_usable_tins = (__$(drug_weights[x][1] + "_pills_per_tin").value || 0)
        var amount = (__$(drug_weights[x][1] + "_amount").value || 0);
        var units_expiring = (__$(drug_weights[x][1] + "_expire_amount").value || 0);
        var expiry_date = (__$(drug_weights[x][1] + "_date").value || "N/A");
      }
      var index = x
      tbody.appendChild(buildRows(drug_weights[index][2], drug_weights[index][6], drug_weights[index][3], drug_weights[index][5],
      amount, expiry_date,units_expiring));
      x++;
    }
    table.appendChild(tbody);
    table.appendChild(tBodySeparator());


    tbody = document.createElement('tbody');
    tbody.setAttribute('id','section_two');
    tbody.appendChild(rowHeading('BOTTLES', 'BOTTLES'));
    amount = '';
    total_usable_tins = '';

    section_two = 2; min = 18; max=19
    while(min <= max) {
      var index = min;
      var total_usable_tins = "0";
      var expiry_date = "N/A";
      var units_expiring = "0";
      var date_value = "N/A";
      
      if (__$(drug_weights[index][1] + "_pills_per_tin")) {
        var total_usable_tins = (__$(drug_weights[index][1] + "_pills_per_tin").value || 0)
        var amount = (__$(drug_weights[index][1] + "_amount").value || 0);
        var units_expiring = (__$(drug_weights[index][1] + "_expire_amount").value || 0);
        var expiry_date = (__$(drug_weights[index][1] + "_date").value || "N/A");
      }

      tbody.appendChild(buildRows(drug_weights[index][2], drug_weights[index][6], drug_weights[index][3], drug_weights[index][5],
      amount, expiry_date,units_expiring));

      min++;
    }
    table.appendChild(tbody);
    table.appendChild(tBodySeparator());
  

    tbody = document.createElement('tbody');
    tbody.setAttribute('id','section_three');
    tbody.appendChild(rowHeading('TABS', 'TABS'));
  
    section_three = 7; min = 20; max = 26;

    while(min <= max) {
      var index = min;
      var total_usable_tins = "0";
      var expiry_date = "N/A";
      var units_expiring = "0";
      var date_value = "N/A";
      if (__$(drug_weights[index][1] + "_pills_per_tin")) {
        var total_usable_tins = (__$(drug_weights[index][1] + "_pills_per_tin").value || 0)
        var amount = (__$(drug_weights[index][1] + "_amount").value || 0);
        var units_expiring = (__$(drug_weights[index][1] + "_expire_amount").value || 0);
        var expiry_date = (__$(drug_weights[index][1] + "_date").value || "N/A");
      }

      tbody.appendChild(buildRows(drug_weights[index][2], drug_weights[index][6], drug_weights[index][3], drug_weights[index][5],
      amount, expiry_date,units_expiring));

      min++;
      if (min == 22 )
        min++
    }
    table.appendChild(tbody);


    inputFrame = document.getElementById('inputFrame1');
    inputFrame.setAttribute('style','overflow: auto')
    inputFrame.appendChild(table);
  }

  function buildRows(item, item_desc, unit, previous_stock, total_usable_tins, expiry_date, units_expiring) {
    if(expiry_date != "N/A"){
      expiry_date = expiry_date.slice(3, 11);
    }
    t = document.createElement('tr');
    tds = [
      ['text-align:left',item],
      ['text-align:right',item_desc],
      ['text-align:center',unit],
      ['text-align:right',previous_stock],
      ['text-align:right',total_usable_tins],
      ['text-align:center',expiry_date],
      ['text-align:right',units_expiring]
    ]

    for(var z = 0; z < tds.length; z++) {
      std = document.createElement('td');
      std.setAttribute('style', tds[z][0]);
      std.innerHTML = tds[z][1];
      if (z >= 4) {
        std.setAttribute('class', 'borders');
      }
      t.appendChild(std);
    }

    return t;
  }

  function tBodySeparator() {
    t = document.createElement('tr');
    sd = document.createElement('td');
    sd.setAttribute('colspan','7');
    sd.innerHTML = '&nbsp;';
    return t.appendChild(sd);
  }


  function rowHeading(heading, second_heading) {
    t = document.createElement('tr');
    ths = [
      ["text-align:left;","Items counted as"],
      ["text-align:right;", heading],
      ["","&nbsp"],
      ["text-align:right;","Previous stock"],
      ["text-align:right;","Total usable " + second_heading.toLowerCase()],
      ["text-align:center;","Date&nbsp;MM/YY"],
      ["text-align:right;","Units expiring that date"]
    ]
  
    for(var i = 0; i < ths.length; i++) {
      th = document.createElement('th');
      th.setAttribute('style',ths[i][0]);
      th.innerHTML = ths[i][1];
      t.appendChild(th);
    }
    return t;
  }

</script>

<script type="text/javascript">

  function trimDate() {
    field = document.getElementById('Date of expiry');
    try {
      date_of_expiry_inputs = jQuery("input[field_type=date_of_expiry]");
      for (var i=0; i<=date_of_expiry_inputs.length - 1; i++){
        if(date_of_expiry_inputs[i].value.length > 8) {
          //date_of_expiry_inputs[i].value = date_of_expiry_inputs[i].value.slice(3,11);
        }
      }

    }catch(e){
      console.log(e)
    }


  }

  setInterval("trimDate();",10);

  for (var j in drugs) {
    for (var i=0; i<=total_rows; i++){
      drug_name = drugs[j] + "_" + i;
      drugs_hash[drug_name] = {"tabs_per_tin":"", "total_tins":"", "date_of_expiry":"", "expiring_tins":""};
    }
  }

  function updateDrugsHash(){
    /*
     *
     try {
      __$(drug_name + "_pills_per_tin").value = __$("Pills per tin").value;
    } catch (x) {
    }

    try {
      __$(drug_name + "_amount").value = __$("Number of tins").value;
    } catch (x) {
    }

    try {
      __$(drug_name + "_expire_amount").value = __$("Number of expiring tins").value;
    } catch (x) {
    }

    try {
      __$(drug_name + "_date").value = __$("Date of expiry").value;
    } catch (x) {
    }
     **/
    input_fields = document.getElementsByClassName("input-field");
    if (input_fields.length > 0){
      drug = document.getElementById("input-header").getAttribute('drug');
      for (var i=0; i<=input_fields.length - 1; i++){
        value = input_fields[i].value;
        row = input_fields[i].getAttribute("row");
        field = input_fields[i].getAttribute("field_type");
        drug_name = drug + "_" + row;

        if (field == 'tabs_per_tin'){
          drugs_hash[drug_name]["tabs_per_tin"] = value;
          __$(drug + "_pills_per_tin").value = value;
        }

        if (field == 'total_tins'){
          __$(drug + "_amount").value = value;
          drugs_hash[drug_name]["total_tins"] = value;
        }

        if (field == 'date_of_expiry'){
          __$(drug + "_date").value = value;
          drugs_hash[drug_name]["date_of_expiry"] = value;
        }
        
        if (field == 'expiring_tins'){
          __$(drug + "_expire_amount").value = value;
          drugs_hash[drug_name]["expiring_tins"] = value;
        }
        
      }
    }
    return drugs_hash
  }

  update_drugs_hash = window.setInterval("updateDrugsHash()", 1000);

  function disableBatchInputs(){
    incomplete_rows = []
    for (var i=0; i<=total_rows.length; i++){
      row_inputs = jQuery("[row=" + i + "]");

    }
  }

  function enableBatchInputs(){

  }

  function validateInputFields(){
    incomplete_rows = [];

    for (var key in drugs_hash){
      drugName = key.split("_")[0];
      row_number = (parseInt(key.split("_")[1]) + 1);

      tabs_per_tin = drugs_hash[key]["tabs_per_tin"];
      total_tins = drugs_hash[key]["total_tins"];
      date_of_expiry = drugs_hash[key]["date_of_expiry"]; //authorization_code
      authorization_code = drugs_hash[key]["authorization_code"];

      if (!row_complete(tabs_per_tin, total_tins, date_of_expiry, authorization_code)){
        incomplete_rows.push([drugName, row_number]);
      }

      if (parseInt(key.split("_")[1]) == 0){
        if (drugs_hash[key]["tabs_per_tin"].length == 0){
          incomplete_rows.push([drugName, row_number]); //The drug has not been clicked yet.
        }
      }

    }

    if (incomplete_rows.length > 0){
      error_message = "<u>Incomplete Entries for the following drugs</u> <br />"
      for (var i=0; i<=incomplete_rows.length - 1; i++){
        drugName = incomplete_rows[i][0];
        row_number = incomplete_rows[i][1];
        error_message += "&nbsp;&nbsp;&nbsp;" + drugName + " on row # " + row_number + '<br />';
      }

      __$('nextButton').onmousedown = function(){
        showMessage(error_message);
      }
    }else{
      __$('nextButton').onmousedown = function(){
        gotoNextPage();
      }
    }
  }

  function row_complete(tabs_per_tin, total_tins, date_of_expiry, authorization_code){
    if (total_tins.length > 0 || date_of_expiry.length > 0 || authorization_code.length > 0){
      if (total_tins.length > 0 && date_of_expiry.length > 0 && authorization_code.length > 0){
        return true
      }else{
        return false
      }
    }else{
      return true
    }

  }

  function addNewRow(){
    input_fields = jQuery('.input-field');
    var complete = true
    for (var i=0; i<=input_fields.length - 1; i++){
      if (input_fields[i].value.length == 0){
        complete = false;
        break;
      }
    }
    if (complete){
      var batch_table = jQuery("#batch-table")[0].getElementsByTagName("tbody")[0];
      var i = parseInt(jQuery( "table input:last" ).attr("row")) + 1;
      var drug = __$('data-pane').getAttribute("drug");

      var drug_name = drug + "_" + i;
      drugs_hash[drug_name] = {"tabs_per_tin":"", "total_tins":"", "date_of_expiry":"", "authorization_code":""};

      var row = document.createElement("tr");

      for (var j = 0; j <= 3; j++) {
        var cell = document.createElement("td");
        cell.style.width = '20px';
        cell.style.textAlign = "center";
        var textField = document.createElement("input");
        if (j == 0){
          //var inputID = "Number of tins";
          var inputID = drug + "_" + i + "_number_of_tins";
          var inputValue = drug_cms_packsizes[drug];
          textField.value = inputValue;
          var field_type = "tabs_per_tin"
        }

        if (j == 1){
          //var inputID = "Number of expiring tins";
          var inputID = drug + "_" + i + "_total_tins";
          var inputValue = drugs_hash[drug_name]["total_tins"];
          var field_type = "total_tins"
        }

        if (j == 2){
          //var inputID = "Date of expiry";
          var inputID = drug + "_" + i + "_date_of_expiry";
          var inputValue = drugs_hash[drug_name]["date_of_expiry"];
          var field_type = "date_of_expiry"
        }

        if (j == 3){
          //var inputID = "Date of expiry";
          var inputID = drug + "_" + i + "_authorization_code";
          var inputValue = drugs_hash[drug_name]["authorization_code"];
          var field_type = "authorization_code"
        }

        textField.className = "input-field";
        textField.id = inputID;
        //textField.value = inputValue;
        textField.setAttribute("field_type", field_type)
        textField.setAttribute("row", i);
        textField.setAttribute("drug_name", drug + "_" + i);
        textField.style.height = '35px';
        textField.style.width = '194px';
        textField.style.fontSize = '26px';
        textField.style.marginLeft = '10px';
        textField.style.textAlign = 'center';

        if (i + j == 0){
          //textField.disabled = true;
        }

        if (j != 2){
          textField.onmousedown = function () {
            jQuery(".input-field").attr("class", "input-field");
            this.className += " input-field-active";
            if (__$('popupkeyboard'))
              __$('data-pane').removeChild(__$('popupkeyboard'));
            if (this.getAttribute('field_type') == 'authorization_code'){
              showSpecialKeyBoard(this)
            }else{
              showKeyboardCustom(this);
            }
          }
        }else{
          textField.onmousedown = function () {
            jQuery(".input-field").attr("class", "input-field");
            this.className += " input-field-active";
            if (__$('popupkeyboard'))
              __$('data-pane').removeChild(__$('popupkeyboard'));
            showDate(__$('data-pane'), this);
          }
        }

        cell.appendChild(textField);
        row.appendChild(cell);
      }
      if ( typeof addedRowsHash[drug] != "undefined"){
        addedRowsHash[drug] += 1;
      }else{
        addedRowsHash[drug] = 1;
      }
      batch_table.appendChild(row);
      jQuery("#batch-table td:first-child, #batch-table th:first-child").hide();
      //////////////////////////////////
    }
  }

  function showDate(parent, target) {

    date = new Date();
    date = new Date(date.getFullYear(), (date.getMonth() + 1), 0);

    months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

    monthNames = {
      "Jan": 0,
      "Feb": 1,
      "Mar": 2,
      "Apr": 3,
      "May": 4,
      "Jun": 5,
      "Jul": 6,
      "Aug": 7,
      "Sep": 8,
      "Oct": 9,
      "Nov": 10,
      "Dec": 11
    };

    var tbl = document.createElement("div");
    tbl.style.display = "table";
    tbl.id = "popupkeyboard";
    tbl.style.marginTop = "270px";
    tbl.style.marginLeft = "18%";
    tbl.style.borderSpacing = "5px";

    parent.appendChild(tbl);

    var cells = [
      [
        {
          "type": "button",
          "id": "btnAddYearFor" + target.id,
          "target": target.id,
          "value": "+",
          "onmousedown": "incrementYear(this.getAttribute('target'))",
          "class": "dbutton bluee",
          "style": "height: 60px; margin: auto; width: 100%;"
        },
        {
          "type": "button",
          "id": "btnAddMonthFor" + target.id,
          "target": target.id,
          "value": "+",
          "onmousedown": "incrementMonth(this.getAttribute('target'))",
          "class": "dbutton bluee",
          "style": "height: 60px; margin: auto; width: 100%; margin-left: 20px;"
        },
        {
          "type": "button",
          "id": "btnAddDateFor" + target.id,
          "target": target.id,
          "value": "+",
          "onmousedown": "incrementDate(this.getAttribute('target'))",
          "class": "dbutton bluee",
          "style": "display: none; height: 60px; margin: auto; width: 100%;"
        }
      ],
      [
        {
          "type": "input",
          "id": "txtYearFor" + target.id,
          "target": target.id,
          "value": date.getFullYear(),
          "onmousedown": "overwriteNumber = true; if(__$('keyboard')){document.body.removeChild(__$('keyboard'));} else {showShield(\"checkDate('\" + this.getAttribute('target') + \"', false)\"); showKeyboard(__$('txtYearFor' + this.getAttribute('target')),{':':':','/':'/','.':'.','abc':'abc'},true);} checkDate(this.getAttribute('target'));",
          "class": "input_cell",
          "style": "font-size: 24px; text-align: center; width: 100%;"
        },
        {
          "type": "input",
          "id": "txtMonthFor" + target.id,
          "target": target.id,
          "value": months[date.getMonth()],
          "onmousedown": "showShield(); addList(__$('txtMonthFor' + this.getAttribute('target')),{'Jan':'January','Feb':'February','Mar':'March','Apr':'April','May':'May','Jun':'June','Jul':'July','Aug':'August','Sep':'September','Oct':'October','Nov':'November','Dec':'December','?':'Unknown'},'single',__$('txtMonthFor' + this.getAttribute('target')),__$('txtMonthFor' + this.getAttribute('target')), 'checkDate(\"' + this.getAttribute('target') + '\")'); checkDate(this.getAttribute('target'));",
          "class": "input_cell",
          "style": "font-size: 24px; text-align: center; width: 100%; margin-left: 23px; "
        },
        {
          "type": "input",
          "id": "txtDateFor" + target.id,
          "target": target.id,
          "value": date.getDate(),
          "onmousedown": "overwriteNumber = true; if(__$('keyboard')){document.body.removeChild(__$('keyboard'));} else {showShield(\"checkDate('\" + this.getAttribute('target') + \"', false)\"); showKeyboard(__$('txtDateFor' + this.getAttribute('target')),{':':':','/':'/','.':'.','abc':'abc'},true);} checkDate(this.getAttribute('target'));",
          "class": "input_cell",
          "style": "display: none; font-size: 24px; text-align: center; width: 100%;"
        }
      ],
      [
        {
          "type": "button",
          "id": "btnSubtractYearFor" + target.id,
          "target": target.id,
          "value": "-",
          "onmousedown": "decrementYear(this.getAttribute('target'))",
          "class": "dbutton bluee",
          "style": "height: 60px; margin: auto; width: 100%;"
        },
        {
          "type": "button",
          "id": "btnSubtractMonthFor" + target.id,
          "target": target.id,
          "value": "-",
          "onmousedown": "decrementMonth(this.getAttribute('target'))",
          "class": "dbutton bluee",
          "style": "height: 60px; margin: auto; width: 100%; margin-left: 20px;"
        },
        {
          "type": "button",
          "id": "btnSubtractDateFor" + target.id,
          "target": target.id,
          "value": "-",
          "onmousedown": "decrementDate(this.getAttribute('target'))",
          "class": "dbutton bluee",
          "style": "display: none; height: 60px; margin: auto; width: 100%;"
        }
      ]
    ];

    for (var i = 0; i < cells.length; i++) {
      var row = document.createElement("div");
      row.style.display = "table-row";

      tbl.appendChild(row);

      for (var j = 0; j < cells[i].length; j++) {
        var cell = document.createElement("div");
        cell.style.display = "table-cell";
        cell.style.width = "140px";
        cell.style.textAlign = "center";

        row.appendChild(cell);

        var input = document.createElement("input");

        for (var key in cells[i][j]) {
          input.setAttribute(key, cells[i][j][key]);
        }

        cell.appendChild(input);
      }
    }

    return tbl;
  }

  function showKeyboardCustom(ctrl) {

    target = ctrl;
    if (target.disabled){
      return;
    }

    if (__$('popupkeyboard'))
      __$('popupkeyboard').parentNode.removeChild(__$("popupkeyboard"));
    var pos;
    numbers = true;
    var div = document.createElement('div');

    div.id = 'popupkeyboard';

    div.borderTop = "20px";
    div.style.zIndex = '1000';

    __$("data-pane").appendChild(div);

    var keys = [
      [1, 2, 3, '&larr;'],
      [4, 5, 6, 0],
      [7, 8, 9, '.']
    ];

    var table = document.createElement('div');
    table.style.display = 'table';
    table.style.margin = 'auto';

    div.appendChild(table);

    var ctrl;

    for (var i = 0; i < keys.length; i++) {
      var row = document.createElement('div');
      row.style.display = 'table-row';

      table.appendChild(row);

      for (var j = 0; j < keys[i].length; j++) {
        var cell = document.createElement('div');
        cell.style.display = 'table-cell';

        row.appendChild(cell);

        if (String(keys[i][j]).trim().length == 0) {
          cell.innerHTML = "&nbsp;";

          continue;
        }

        var button = document.createElement('div');
        button.style.width = '65px';
        button.style.height = '60px';
        button.style.minWidth = '40px';
        button.style.minHeight = '40px';
        button.style.margin = '2px';
        button.style.fontSize = "24px";

        button.id = keys[i][j];

        if (target && keys[i][j] == '.') {
          if (target.value.trim().match(/\./) || target.value.trim().length == 0) {
            button.setAttribute('class', 'butt gray');
          } else {
            button.setAttribute('class', 'butt bluee');
          }
        }

        button.innerHTML = keys[i][j];

        button.setAttribute('class', 'butt bluee');

        button.onmousedown = function () {

          if (!this.className.match(/gray/)  && target.disabled != true) {
            if (this.innerHTML.trim().charCodeAt(0) == 8592) {
              if (target) {
                target.value = target.value.trim().substring(0, (target.value.trim().length - 1));
              }
            } else {

              target.value += this.innerHTML.trim();

            }
          }
        }

        cell.appendChild(button);
      }
    }

  }

  function showSpecialKeyBoard(ctrl){

    target = ctrl;
    if (target.disabled){
      return;
    }

    if (__$('popupkeyboard'))
      __$('popupkeyboard').parentNode.removeChild(__$("popupkeyboard"));
    var pos;

    numbers = true;
    var div = document.createElement('div');

    div.id = 'popupkeyboard';
    div.className = 'special-custom-keyboard';

    div.borderTop = "20px";
    div.style.zIndex = '1000';

    __$("data-pane").appendChild(div);

    var keys = [
      [0, 1, 2, 3, 4, 5, 6, 7, 8, 9],
      ['Q', 'W', 'E','R', 'T', 'Y', 'U','I', 'O', 'P'],
      ['A', 'S', 'D', 'F', 'G', 'H', 'J','K','L', 'Z'],
      ['X', 'C', 'V', 'B', 'N', 'M', '&larr;']
    ];

    var table = document.createElement('div');
    table.style.display = 'table';
    table.style.margin = 'auto';

    div.appendChild(table);

    var ctrl;

    for (var i = 0; i < keys.length; i++) {
      var row = document.createElement('div');
      row.style.display = 'table-row';

      table.appendChild(row);

      for (var j = 0; j < keys[i].length; j++) {
        var cell = document.createElement('div');
        cell.style.display = 'table-cell';

        row.appendChild(cell);

        if (String(keys[i][j]).trim().length == 0) {
          cell.innerHTML = "&nbsp;";

          continue;
        }

        var button = document.createElement('div');
        button.style.width = '65px';
        button.style.height = '60px';
        button.style.minWidth = '40px';
        button.style.minHeight = '40px';
        button.style.margin = '2px';
        button.style.fontSize = "24px";

        button.id = keys[i][j];

        if (target && keys[i][j] == '.') {
          if (target.value.trim().match(/\./) || target.value.trim().length == 0) {
            button.setAttribute('class', 'butt gray');
          } else {
            button.setAttribute('class', 'butt bluee');
          }
        }

        button.innerHTML = keys[i][j];

        button.setAttribute('class', 'butt bluee custom-butt');

        button.onmousedown = function () {

          if (!this.className.match(/gray/)  && target.disabled != true) {
            if (this.innerHTML.trim().charCodeAt(0) == 8592) {
              if (target) {
                target.value = target.value.trim().substring(0, (target.value.trim().length - 1));
              }
            } else {

              target.value += this.innerHTML.trim();

            }
          }
        }

        cell.appendChild(button);
      }
    }
  }

</script>
<style>
  #popupkeyboard{
    margin-top: 50px !important;
    border-spacing: 5px;

  }

  .messageBar {
    width: 700px;
  }

  .custom-butt{
    padding: 7px 4px 0px 0px !important;
  }

  .special-custom-keyboard{
    margin-left: -29%;
  }
</style>

<style type="text/css">
  .summary-table {
    width: 100%;
    padding-right: 5px;
  }

  .borders {
    border-style: solid;
    border-width: 1px;
    width: 130px;
  }

  #input-header {
    font-size: 17px;
  }
</style>